# 데이터베이스 클러스터

- 하나의 데이터베이스를 여러 개의 서버(or 가상 서버) 상에 구축하는 것
- 데이터베이스 파티셔닝은 DB를 여러 부분으로 분할하는 것을 의미하며, 각 파티션은 여러 노드로 분할 배치되어 여러 사용자가 각 노드에서 트랜잭션을 수행할 수 있다.
- 데이터 통합 시, **성능과 가용성의 향상을 위해 데이터베이스 차원의 파티셔닝 또는 클러스터링을 이용**한다.

## 파티셔닝 구현의 효과

- **병렬처리** : 빠른 데이터 검색 및 처리 성능
- **고가용성** : 특정 파티션에 **장애가 발생**해도 **서비스는 중단되지 않음**
- **성능향상** : 성능의 **선형적인 증가 효과**를 볼 수 있음

## 데이터베이스 클러스터 구분

- 단일 서버 내의 파티셔닝과 다중서버 사이 파티셔닝으로 구분
- 리소스 공유 관점에서는 무공유 디스크(Shared Nothing)와 공유 디스크(Shared Disk)로 구분

### 무공유 디스크

- 각 DB 인스턴스는 자신이 관리하는 데이터 파일을 자신의 로컬 디스크에 저장하며, 파일을 노드 간 공유하지 않는다.
- 각 인스턴스나 노드는 **완전히 분리된 데이터의 서브 집합에 대한 소유권을 갖고** 있으며, 각 데이터는 소유권을 가진 인스턴스가 처리한다.
- 한 노드가 데이터 처리 요청을 받으면, 해당 노드는 처리할 데이터를 갖고 있는 노드에 신호를 보내 데이터 처리를 요청한다.
- **Oracle RAC(Real Application Cluster)를 제외한 대부분의 데이터베이스 클러스터가 무공유 방식**이다.

- **장점** : 노드 확장에 제한이 없음
- **단점** : 각 노드에 장애 발생을 대비해 **별도의 폴트톨러런스(fault-tolerance)를 구성**해야 함
    - fault-tolerance : 시스템 고장 발생 시에도 기능을 기존과 같이 유지하는 기술

### 공유 디스크

- 모든 데이터베이스 인스턴스 노드들은 데이터 파일을 논리적으로 공유하며, **각 인스턴스는 모든 데이터에 접근**할 수 있다.
- 데이터를 공유하려면 **SAN(Storage Area Network)**과 같은 네트워크가 반드시 필요하다.
- **모든 노드가 데이터를 수정**할 수 있어서, 노드 간 동기화 작업 수행을 위한 별도의 커뮤니케이션 채널이 필요하다.

- **장점** : 높은 수준의 **폴트톨러런스(fault-tolerance)를 제공**하여, 클러스터 구성 노드 중 하나의 노드만 살아있어도 서비스 가능
- **단점** : 클러스터가 커지면 **디스크 영역에서 병목현상** 발생

## 데이터베이스 클러스터 종류

### Oracle RAC 데이터베이스 서버

- Oracle RAC(Real Application Cluster)는 **공유 클러스터**이다.
- 모든 노드는 DB 내 모든 테이블에 동등하게 액세스하며, **특정 노드가 데이터를 '소유'하는 개념이 없다.**
- 파티셔닝할 필요는 없지만, 성능 향상을 위해 파티셔닝되는 경우가 많다.
- 응용 프로그램은 클러스터 특정 노드가 아니라, RAC 클러스터에 연결하며, RAC 클러스터는 모든 노드에 로드를 고르게 분산한다.
- 도입 비용 때문에 확장성이 중요한 경우보다 고가용성을 요구하는 데이터에 많이 사용된다.
- **장점**
    - 가용성 : 높은 수준의 폴트 톨러런스
    - 확장성 : 새 노드를 클러스터에 쉽게 추가 가능, 이 때 모든 노드 간 균형이 유지 되도록 로드가 다시 분산됨
        - Oracle 10g R2 rAC는 클러스터 내에 최대 100개의 노드 지원
    - 비용 절감 : RAC는 표준화된 소규모(CPU 4개 미만) 저가형 상용 하드웨어의 클러스터에서도 고가의 SMP 시스템만큼 효율적으로 응용 프로그램을 실행하여 하드웨어 비용을 절감함.
        - 4CPU의 16노드 클러스터를 사용하면 동급 성능의 64CPU SMP 시스템에 비해 비용을 크게 절감할 수 있음.

### IBM DB2 ICE(Integrated Cluster Environment)

- CPU-메모리-디스크를 파티션별 독립적으로 운영하는 **무공유 방식의 클러스터링**
- 애플리케이션은 여러 파티션에 분산된 DB를 하나의 DB로 보고, 데이터가 어느 파티션에 있는지는 알 필요 없다.
- 데이터와 사용자가 증가해도 애플리케이션 수정은 필요 없으며, 노드 추가 및 데이터 재분재를 통해 성능과 용량을 일정히 유지 가능하다.
- 각 노드로 분산되는 파티셔닝 구성에 따라 성능 차이가 많이 발생할 수 있다.
- 별도의 페일오버(Failover) 메커니즘이 필요하므로, DB2를 이용하여 클러스터링 구성 시에는 공유 디스크 방식을 사용하여 가용성을 보장한다.

### 마이크로소프트 SQL Server

- **연합(Federated) 데이터베이스** 형태로 여러 노드로 확장할 수 있는 기능 제공
- 연합 DB는 디스크 등을 공유하지 않는 독립적 서버에서 실행되는 서로 다른 DB들 간의 논리적인 결합이며, 네트워크를 이용하여 연결된다.
- 데이터는 관련 서버들로 수평 분할되며, 테이블을 논리적으로 분리해 물리적으로는 분산된 각 노드에 생성한다.
- 페일오버(Failover) 메커니즘을 제공하지만, Active-Active가 아닌 **Active-Standby 방법을 사용**하고 있다.
    - Active-Standby : Active 상태가 Standby 상태를 제어하는 방식
- DPV(Distributed Partitioned View)
    - SQL Server에서 분산 환경의 데이터에 대한 싱글 뷰를 부르는 명칭
    - 각 노드의 DB 인스턴스 사이 링크를 구성한 후, 모든 파티션에 대해 UNION ALL을 이용해 논리적 뷰(VIEW)를 구성하는 방식으로 제공
- **문제점**
    - DBA나 개발자가 파티셔닝 정책에 맞게 테이블과 뷰를 생성해야 한다.
    - 전역 스키마 정보가 없기 때문에 질의 수행을 위해 모든 노드를 액세스해야 한다.
    - 노드가 많아지거나 추가/삭제가 발생하는 경우, 파티션을 새로 구성해야 한다. 이 때 페일오버는 별도로 구성해야 한다.

### MySQL

- **무공유** 방식이며, **메모리 기반 데이터베이스의 클러스터링을 지원**
    - 5.1.6 버전 이상에서는 디스크 기반 클러스터링 제공하며, 인덱스가 생성된 칼럼은 기존처럼 메모리에 유지되지만, 인덱스를 생성하지 않은 칼럼은 디스크에 저장된다.
- 특정 하드웨어 및 소프트웨어를 요구하지 않고, 병렬 서버구조 확장이 가능하다.
- 데이터의 가용성을 높이기 위해 데이터를 다른 노드에 복제시키며, 특정 노드에 장애가 발생해도 지속적인 데이터 서비스가 가능하다.
- 장애 노드가 복구되어 클러스터에 투입되면, 기존 데이터와 변경된 데이터에 대한 동기화가 자동으로 수행된다.
- 데이터는 동기화 방식으로 복제되며, 이를 위해 일반적으로 데이터 노드 간 별도의 네트워크를 구성한다.

#### 구성 요소

- **관리 노드 (Management Node)**
    - **클러스터를 관리**하는 노드로 클러스터 시작과 재구성 시에만 관여
- **데이터 노드 (NDB Node)**
    - 클러스터의 **데이터를 저장**하는 노드
- **MySQL 노드**
    - 클러스터 데이터에 **접근을 지원**하는 노드

#### 제한 사항

- 클러스터 참여 노드(SQL 노드, 데이터 노드, 매니저 포함) 수는 **255로 제한**한다. **데이터 노드는 최대 48개**까지만 가능하다.
- 운영 중 노드를 추가/삭제할 수 없다.
- 파티셔닝은 LINEAR KEY 파티셔닝만 사용 가능하다.
- 트랜잭션 수행 중에 롤백 지원을 안 한다. 작업 수행 중 문제 발생 시, 전체 트랜잭션 이전으로 롤백해야 한다.
- 하나의 트랜잭션에 많은 데이터 처리 시 메모리 부족 문제가 발생할 수 있어, 여러 트랜잭션으로 분리해 처리하는 것이 좋다.
- 칼럼명 길이는 31자, 데이터베이스의 테이블명 길이는 122자까지로 제한된다. 데이터베이스 테이블, 시스템 테이블, 블롭(BLOB) 인덱스 포함한 메타데이터는 2만 320개까지만 가능하다.
- 클러스터에서 생성 가능한 테이블 수는 최대 2만 320개다. 한 로우(row)의 크기는 8KB다. BLOB 미포함 시 테이블 키는 32개가 최대다.
- 모든 클러스터의 기종은 동일해야 한다. 기종에 다른 비트 저장방식이 다르면 문제가 발생할 수 있다.
- 디스크 기반 클러스터일 경우 tablespace의 개수는 $2^{32}$, tablespace 당 데이터 파일의 개수는 $2^{16}$, 데이터 파일의 크기는 32GB까지 가능하다.