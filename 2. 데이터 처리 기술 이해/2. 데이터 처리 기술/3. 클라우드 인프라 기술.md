# 클라우드 컴퓨팅

- 동적 확장 가능한 가상화 자원들을 인터넷으로 서비스하는 기술
- 클라우드 서비스 유형
    - IaaS (Intrastructure as a Service)
        - 네트워크 장비, 서버와 스토리지 등 IT 자원을 빌려주는 클라우드 서비스
        - **VMWare, Xen, KVM 등 서버 가상화 기술 → IaaS에 주로 활용**
    - SaaS (Software as a Service)
        - 소프트웨어를 웹에서 사용할 수 있게 해주는 서비스
        - 아마존이 S3 환경을 제공함으로써 PaaS를 최초 실현
        - AWS의 **EMR(Electric MapReduce)**은 **하둡을 온디맨드(On-Demand)**로 이용 가능
    - PaaS (Platform as a Service)
        - 애플리케이션이나 소프트웨어 개발 시 필요한 플랫폼을 제공하는 서비스
- 구글의 AppEngine, Apps, Gears, Gadgets 등을 제공하여, 웹 기반 소프트웨어가 클라우드 서비스에서 구체화되는 것을 보임

## 서버 가상화 개념 및 특징

- 물리적인 서버와 운영체제 사이에 적절한 계층을 추가하여, 서버를 사용하는 사용자에게 **물리적 자원은 숨기고 논리적 자원만 보여주는 기술**
- 하나의 서버에 여러 개의 애플리케이션 미들웨어, 운영체제들이 서로 영향을 미치지 않으며 동시에 사용 가능
- 다양한 기술들이 있는데, 메인프레임, 유닉스 서버, x86 서버 등에 따라 서로 다른 기술이나 분류 체계 사용
- x86 계열 서버가 클라우드 컴퓨팅 환경에서 많이 사용됨
    - 하드웨어, CPU, 운영체제 공급 업체가 모두 다르며, 가상화 기술도 업체에 따라 제공되는 수준이 다양함

## 서버 가상화 기술의 효과

### 가상머신 사이의 데이터 보호

- 하나의 물리 서버에서 운영 중인 서로 다른 가상 머신들 간 접속은 정상적인 네트워크 접속만 허용된다.
- 가상머신은 보안 상 서로 분리되어 데이터 보호를 받는다.

### 예측하지 못한 장애로부터 보호

- 서로 다른 가상머신에서 발생하는 장애는 서로 간 영향을 미치지 않는다.
- 애플리케이션, 운영체제의 장애로부터 보호 받을 수 있다.

### 공유 자원에 대한 강제 사용 거부

- 가상머신이 할당된 자원보다 많이 가져가는 것을 차단할 수 있다.
- 다른 가상머신에 할당된 자원이 부족해도 영향이 없도록 차단할 수 있다.

### 서버 통합

- 더 많은 컴퓨팅 자원이 필요하지만 물리적 자원이 제한적인 문제가 많다.
- 기존 서버 용량 증설 및 가상머신 추가를 통해 **동일한 데이터센터의 물리적 자원을 이용하며 더 많은 서버를 운영**할 수 있다.

### 자원 할당에 대한 증가된 유연성

- 수시로 변화하는 가상머신의 자원 요구량에 맞춰 전체 시스템 자원을 재배치함으로써 자원 활용도 극대화 가능

### 테스팅

- 다양한 운영체제, 운영환경에서 테스트가 필요한 경우, 새로운 서버를 추가하지 않아도 테스트 가능하다.
- 부하 테스트가 필요한 경우, 일시적으로 자원을 줄여서 테스트 가능하며, 다수의 부하 생성 역할을 수행하는 노드도 쉽게 추가 가능하다.

### 정확하고 안전한 서버 사이징

- 필요한 자원만큼만 가상머신 할당 가능하다.

### 시스템 관리

- 마이그레이션 기능을 통해 운영 중인 가상머신의 중지 없이 다른 물리 서버로 이동 가능
    - **하드웨어 장애 해결** : 여러 디스크 중 1개에서 장애 발생 시, 장애 장비에서 운영 중인 가상머신을 다른 장비로 이동 후 장애 해결 가능
    - **로드 밸런싱** : 특정 가상 서버나 물리 서버 부하 집중 시, 여유 있는 서버로 가상머신 이동 가능
    - **업그레이드** : 가상머신을 다른 장비로 이동 후 기존 물리적 자원의 업그레이드 작업 수행 가능

# CPU 가상화

## 하이퍼바이저

- 물리적 서버 위에 존재하는 가상화 레이어를 통해, 운영체제 수행에 필요한 하드웨어 환경을 가상으로 만듦
- 호스트 컴퓨터에서 다수의 운영 체제를 동시에 실행하도록 하기 위한 논리적인 플랫폼을 의미
- 일반적으로 가상머신(Virual Machine)을 하이퍼바이저라 할 수 있고, 하이퍼바이저는 VMM(Virtual Machine Monitor)라고 한다.
- x86 계열 서버 가상화에서는 소프트웨어 기반으로 하이퍼바이저를 구성한다.
- 하이퍼바이저를 통해 사용자는 추가 하드웨어 구입 없이 새로운 운영체제 설치, 애플리케이션의 테스팅 및 업그레이드를 동일한 물리적 서버에서 동시 수행 가능하다.

### 기능

- 하드웨어 환경 에뮬레이션 (Emulates a complete hardware environment)
- 실행환경 격리 (Isolate execution in each VM)
- 시스템 자원 할당 (Allocates platform resources-processing, memory, I/O, storage)
- 소프트웨어 스택 보존 (Emcapsulates software stacks including the OS and state information)

### 관련 기술 분류

#### 플랫폼별

- x86 계열 : VMware, MS Virtual Server, Xen
- 유닉스 계열 : IBM의 POWER Hypervisor 등
- 메인 프레임 계열 : z/VM과 하드웨어 펌웨어로 분류되는 PR/SM 등

#### 하이퍼바이저 위치와 기능에 따른 분류

- 베어메탈(Bare-metal) 하이퍼바이저
    - 하드웨어와 호스트 운영체제 사이에 위치
    - 반가상화(Para Virtualization)과 완전가상화(Full Virtualization)으로 구분 가능
- 호스트 기반(Hosted) 하이퍼바이저
    - 호스트 운영체제와 게스트 운영체제 사이에 위치

#### Privileged 명령어 처리 방법에 따른 분류

- x86 아키텍처에서 가상화 기술의 핵심은 가상머신이 요청하는 Priviledged 명령어를 어떻게 어떤 계층에서 처리하느냐이다.
- **완전가상화(Full Virtualization), 반가상화(Para Virtualization)**가 해당 기준으로 분류된 것

![x86_privilege_level](./x86_privilege_level.png)

- `x86 아키텍처`로, 하드웨어 접근 권한 관리를 위해 `Ring 0`부터 `Ring 3`까지 4개 레벨로 구성돼 있다.
    - 일반 사용자 애플리케이션은 `Ring 3`에서 수행되며, 운영체제는 `Ring 0`에서 수행된다.
- 가상머신도 운영체제가 필요하므로 `Ring 0` 권한을 필요로 한다.

## 완전 가상화

- 하이퍼바이저보다 우선순위과 낮은 가상머신에서는 실행되지 않는 Privileged 명령어에 대해 Trap을 발생시켜 하이퍼바이저에서 실행하는 방식
- VMware ESX Server, MS Virtual Server 등의 제품이 완전 가상화 기반 솔루션

### 장점

- **CPU뿐만 아니라 모든 자원을 하이퍼바이저가 직접 제어·관리** → **어떤 운영체제라도 수정하지 않고 설치 가능**
- MS 윈도우 같은 Guest OS가 하이퍼바이저 상에서 변경 없이 실행 가능

### 단점

- 하이퍼바이저가 자원을 직접 제어하므로 성능에 영향 미침
- 자원들이 하이퍼바이저에 너무 밀접하게 연관되어, 운영 중인 게스트 운영체제에 할당된 자원에 대한 동적변경 작업이 단일 서버 내에서는 어려움
    - 자원에 대한 동적변경을 위해 VMware의 VMotion 같은 솔루션의 도움이 필요
- 반가상화에 비해 속도가 느림

## 하드웨어 지원 완전 가상화

- 기존 완전 가상화 방식에서 Intel VT-x, AMD-V CPU 하드웨어에서 제공하는 가상하 기능 이용
- 가상머신에서 하드웨어에 명령을 내릴 수 있는 반가상화 수준의 성능 발휘가 가능하도록 개선 중
- CPU에 `Ring -1` 계층을 추가하여 하이퍼바이저가 `Ring -1`에서 수행되도록 한다. (Privileged 명령 추가 변환 필요 없음)
- 윈도우 2008 서버의 Hyper-V는 반드시 가상화 지원 CPU만 사용해야 함
- 빠른 성능 : 하이퍼바이저 → 하드웨어로 명령이 바로 전달
- 인텔이 제시하는 주의점 : "기본적으로 CPU 사용률이 높은데, 특히 I/O나 메모리 많이 사용하는 경우 더욱 높아진다. 서버 통합 목적 시 비효율적일 수 있다."
    - 인텔은 반가상화와 하드웨어 지원 완전 가상화 모두 사용하는 하이브리드 가상화 제시
    - Xen을 이용한 하이브리드 가상화의 경우, 반가상화용 운영체제에 하드웨어 지원 완전 가상화 모듈 탑재
        - 명령어 종류에 따라 반가상화 or 완전 가상화 선택·사용 가능

## 반가상화

- Privileged 명령어를 게스트 운영체제에서 Hypercall로 하이퍼바이저에 전달하고, 하이퍼바이저는 Hypercall에 대해 Priviledged 레벨에 상관없이 하드웨어로 명령 수행
    - Hypercall : 게스트 운영체제에서 요청 하면 하이퍼바이저에서 바로 하드웨어 명령을 실행하는 Call
    - 직접 호출하므로 속도가 빠르지만, 커널 변경이 필요 / 완전 가상화는 별도 모듈과 통신을 통해 처리하므로 속도는 느리지만, 커널 변경이 없음
- 게스트 운영체제가 Hypercall을 요청하기 위해서는 게스트 운영체제의 일부분이 수정 되어야 함
    - Xen 기반의 리눅스 운영체제는 20% 정도 커널이 수정됨
- 수정된 게스트 운영체제는 CPU 및 메모리 자원에 대한 직접적인 제어권을 가짐으로써 동적 가상화 환경에 유연하게 적응 가능
    - CPU 및 메모리 자원의 동적 변경이 서비스 중단 없이 이루어지며, 완전 가상화 대비 성능이 뛰어남
- VMware와 같은 상용 솔루션은 완전 가상화와 반가상화의 장단점을 보완해 아키텍처, 기능, 성능 등에서 뚜렷한 차이가 없음
- VMI(Virtual Machine Interface)라는 표준 인터페이스 제시하고, 인터페이스를 준수하는 모든 게스트 운영체제를 지원
    - 정식 표준은 아니지만, 리눅스 진영에서 도입하려는 움직임이 있음

## 하이퍼바이저 기반 가상화 기술비교

|구분                                     |완전 가상화(CPU 기술 X)        |완전 가상화(CPU 기술 O)                    |반가상화                                                                         |
|:---------------------------------------:|:------------------------------|:------------------------------------------|:--------------------------------------------------------------------------------|
|사용기술                                 |바이너리 변환, Direct Execution|Privileged Instruction은 Ring -1로 처리    |수정된 OS 사용                                                                   |
|게스트 OS 변경 여부                      |변경 필요 없음                 |변경 필요 없음                             |hypercall 가능하도록 변경 필요                                                   |
|게스트 OS 호환성                         |호환성 뛰어남                  |호환성 뛰어남(단, CPU가 지원 필요)         |호환성 안 좋음                                                                   |
|성능                                     |좋음                           |Fair(Binary Translation 방식의 성능에 근접)|특정 경우에 더 좋음                                                              |
|제품                                     |VMware, Microsoft, Parallels   |VMware, Microsoft, Parallels, Xen          |VMware, Xen                                                                      |
|게스트 OS가 하이퍼바이저에<br>독립적 여부|독립적                         |독립적                                     |Xen 반가상화는 Xen 하이퍼바이저에서만 동작,<br> VMI-Linux는 하이퍼바이저에 독립적|

## Monolithic VS Microkernel

- 하이퍼바이저 구조에 대한 기준으로 구분되는 방식, 하드웨어에 대한 드라이버가 어느 계층에 있는지에 따라 구분된다.

| 구분        | Monolithic                    | Microkernel                            |
|:-----------:|:------------------------------|:---------------------------------------|
| 구조        | 모든 기능이 하이퍼바이저 내부 | 최소 기능만 커널에, 나머지는 서비스 VM |
| 성능        | 오버헤드 적음, I/O 빠름       | 성능 오버헤드 상대적으로 큼            |
| 안정성/보안 | 복잡 → 취약점 많음            | 단순 → 보안성·안정성 우수              |
| 유지보수    | 어렵고 수정 영향 범위 큼      | 유연, 모듈 단위로 관리 가능            |
| 대표        | VMware ESXi, KVM              | Xen, seL4 기반                         |
- GPT에 의한 요약표이다.

### Monolithic

- 하드웨어 접근 시 사용하는 드라이버를 하이퍼바이저 계층이 모두 보유
- 성능은 조금 향상되지만, 하드웨어 추가나 드라이버 업데이트 되는 경우 하이퍼바이저가 수정되어야 함
- 하이퍼바이저가 많은 코드를 갖고 있기 때문에 장애가 발생할 가능성이 큼

### Microkernel

- 하드웨어 접근 시 사용하는 드라이버를 각 가상머신이 보유
- 호스트 운영체제가 드라이버를 갖고, 게스트 운영체제는 가상 드라이버를 갖고 있어, I/O 요청 시 호스트 운영체제를 거쳐야 함
- 게스트와 호스트는 서로 격리되어 있어, 하이퍼바이저(또는 VMBus)를 이용해 요청을 주고 받음
- 속도는 조금 느리지만 하이퍼바이저 계층이 간단하여 드라이버 업데이트나 하드웨어 추가에 따른 하이퍼바이저 변경이 필요 없고, 장애 발생 확률이 낮음

## 호스트 기반 가상화

- 완전한 운영체제 설치 후, 하이퍼바이저가 호스트 운영체제 위에 탑재되는 방식
- 성능 및 자원 관리 능력 측면에서도 제약 사항이 많음
- 단일 운영체제의 취약성 보유 : 호스트 운영체제 레벨에서 보안 이슈 발생 시 전체 게스트 운영체제의 신뢰성에 문제 발생
- VMware, Workstation, Microsoft Virtual PC 등이 해당 가상화 방식
- 주로 테스트 환경에서 많이 사용되고, 최근에는 별로 사용되지 않음

## 컨테이너 기반 가상화

- 호스트 운영체제 위에 가상의 운영체제 구성을 위한 운영 환경 계층을 추가하여, **운영체제만 가상화한 방식**
- **가상화를 지원하는 계층을 가상 운영환경**(Virtual Server Environment)라고 부름 (하이퍼바이저 X)
- 오픈소스로 OpenVZ, Virtuozzo, Solaris Containers, Linux-VServer 등 여러 솔루션 존재

### 장점

- 운영체제만 가상화 대상으로 하여, 다른 방식에 비해 훨씬 적게 가상화 진행
- **가상화 수준이 낮기 때문**에 다른 방식 대비 **빠른 성능**
- 한 대의 서버에서 더 많은 컨테이너 실행 가능

### 단점

- 자원 간 격리 수준이 낮아 하나의 가상 운영체젱서 실행되는 애플리케이션의 자원 사용에 따라 다른 가상 운영체제가 영향 받음
- 호스트 운영체제의 보안 취약성에 의해 모든 가상 운영체제에 문제 발생 가능
- **호스트 운영체제의 문제가 전체 가상 운영체제에 영향을 미침**

## 하이퍼바이저 기반 VS 컨테이너 기반 가상화 비교

|구분           |하이퍼바이저 기반(Full, Para)                              |컨테이너 기반                                      |
|:-------------:|:---------------------------------------------------------:|:-------------------------------------------------:|
|하드웨어 독립성|가상머신 내에서 완전 독립                                  |호스트 OS 사용                                     |
|OS 독립성      |호스트 OS와 완전 독립(리눅스 윈도우 머신 동시 사용)        |호스트와 게스트 동일                               |
|격리 수준      |높은 격리 수준                                             |낮은 격리 수준                                     |
|성능           |높은 오버헤드 발생<br>성능 향상을 위해 HW 가상화 기술 병행 |오버헤드 거의 없음<br>HW 자원 대부분을 활용        |
|관리           |가상머신 별로 별도 관리                                    |공통 SW 중앙 집중식 관리                           |
|응용분야       |이기종 통합(윈도우 리눅스 혼합 환경)                       |단일 OS 환경 자원 통합 대규모 호스팅 업체          |
|대표제품       |VMware ESC, MS Virtual Server, Xen(Para Virtualization)    |Virtuozzo(상용, OpenVZ-공개), Sun Solaris Container|

# 메모리 가상화 : VMware 기법

- 한 대의 컴퓨터로 마치 여러 대의 컴퓨터를 사용하는 것과 같이 가상 공간을 만들어주는 프로그램
- 운영체제는 메모리를 관리하기 위해 물리주소와 가상주소를 사용
    - 물리주소(Physical Address) : 0부터 시작하는 실제 물리적 메모리 크기
    - 가상주소(Virtual Address) : 하나의 프로세스로 가리킬 수 있는 최대 크기 (32bit OS 기준 4GB)
- **가상 주소 값의 위치**(VPN, Virtual Page Number)를 실제 **물리적인 주소 값 위치**(MPN, Machine Page Number)로 **매핑**하는 과정이 필요하며, Page Table을 이용
    - **TLB**(Translation Lookasice Buffer) : **매핑 연산을 하드웨어적으로 도와주는 것**
- **VMkernel** : VMware 하이퍼바이저 핵심 모듈
    - **Service Console, 디바이스 드라이버들의 메모리 영역을 제외한 나머지 전체 메모리 영역을 모두 관리하면서, 가상머신에 메모리를 할당**
- 생성되는 가상머신은 자신에게 할당된 메모리들을 연속된 공간의 실제 물리적인 메모리로 인식
- 하이퍼바이저 내에 **Shadow Page Table**을 별도로 둬서, 가상 메모리 주소와 물리 메모리 주소의 중간 변환 과정을 가로챔
    - Shadow Page Table은 연속된 빈 공간의 메모리가 실제 존재하는 것처럼 게스트 운영체제에게 매핑해주는 역할<br>
        동시에 개별적인 모든 가상머신들이 자신만의 메모리 주소 공간을 갖도록 함

## 가상머신 메모리 할당 문제 해결 방법

### Memory Ballooning

- 하이퍼바이저가 가상머신 운영체제를 속여 메모리 비우게 만들고, 빈 메모리를 다른 가상머신에 나눠주는 기술

1. 예약된 메모리보다 더 많은 메모리를 사용하는 가상머신 발생
2. 하이퍼바이저(VMkernel)가 해당 가상머신의 메모리 영역을 빈 값으로 강제로 채움
3. 가상머신 운영체제가 자체적으로 Swapping 수행
    - Swapping : 메모리 부족 시, 사용하지 않는 데이터를 디스크로 전송하여 필요한 공간을 확보하는 과정
4. 가상머신 운영체제에서 물리적 메모리(실제로 하이퍼바이저에서 제공한 논리적 메모리)가 채워지고 있다는 것을 감지
5. 가상머신 운영체제는 사용하지 않는 메모리 페이지를 디스크에 있는 Swap 파일로 옮겨(Page Out) 메모리를 비움
    - Page Out : 메모리의 특정 페이지(데이터 조각)을 디스크로 내보내는 동작
6. 하이퍼바이저는 Page Out 된 메모리 영역, 비워진 메모리 영역을 회수 후 다른 가상머신에 재할당

### Transparent Page Sharing

- 각 가상머신에 할당된 메모리 중 동일한 내용을 담고 있는 페이지는 물리적인 메모리 영역에 하나만 존재시키고, 모든 가상머신이 공유하도록 하는 방법

### Memory Overcommitment

- 앞선 2가지 방법(Memory Ballooning, TPS)을 이용하여, 각 가상머신에 할당된 메모리 총합이 실제 물리적 메모리보다 많도록 설정하는 것
- 모든 가상머신이 메모리 사용이 많은 업무를 수행할 경우, 심각한 성능 저하 현상이 발생할 수 있으므로 권장되는 방법은 아님

# I/O 가상화

- 하나의 물리적 장비에 여러 가상머신이 실행되고 있는 상황일 경우, I/O에서 병목현상이 문제 가장 문제됨
- CPU 자원의 파티셔닝 + I/O 자원 공유 및 파티셔닝까지 이루어져야 가상화 기술을 제대로 활용 가능
- 하나의 물리적 머신에서 운영되는 가상머신 간 통신도 이루어져야 함
    - 가상 디스크 어댑터, 가상 이더넷 어댑터, 공유 이더넷 어댑터 등의 기술들 사용됨

## 가상 이더넷

- 대표적인 I/O 가상화 기술의 하나
- **물리적으로 존재하지 않는 자원을 만들어 내는 에뮬레이션(Emulation) 기능**을 이용
- 각 가상머신들 간 메모리 버스를 통해 고속 및 고효율 통신 가능
    - 물리적인 네트워크 어댑터 없이도 가능
- 가상 LAN 기술 기반으로 한 네트워크 파티션도 가능
    - 하나의 서버에 4개의 가상머신 구성 시, 2개의 가상머신을 묶어 가상 LAN으로 구성하면 각 가상 LAN 사이에는 통신 불가
- 별도의 물리적 어댑터와 케이블 없이 **네트워크 이중화, 네트워크의 안정적 단절** 등 효과 획득

## 공유 이더넷 어댑터

- 여러 개의 가상머신이 **물리적인 네트워크 카드를 공유**할 수 있게 하며, 공유된 물리적 카드를 통해 **외부 네트워크와 통신 가능**
    - 가상머신 개수보다 물리적 어댑터 개수가 적은 경우, 여러 가상머신들이 물리적 이더넷 어댑터를 공유할 수 있게 해줌
    - 단, 하나의 자원을 여러 가상머신이 공유하기 때문에 **병목현상 발생**
- 최근 10G 환경에서 네트워크 어댑터 내에서 가상화를 지원하여,<br>어댑터 메모리 버퍼를 가상머신 별로 할당하여<br>마치 하나의 물리적 어댑터를 가상머신 하나에 할당하는 것과 동일한 효과를 내는 제품도 출시

## 가상 디스크 어댑터

- 외장 디스크를 사용할 수 있게 해주는 파이버 채널 어댑터(Fiber Channel Adapter)와 같은 I/O 어댑터의 부족이 가장 큰 문제
- **가상화된 환경에서 가상 디스크를 이용해 가상머신이 디스크 자원을 획득하는 방법에는 "내장 디스크"와 "외장 디스크" 2가지 존재**

### 내장 디스크

- 가상 I/O 레이어가 내장 디스크들을 소유하고, 내장 디스크들을 논리적 디스크 드라이브로 나눔
- 논리적으로 나눠진 드라이버는 LUN(Logical Unit Number)으로 각 파티션에 가상 디스크 어댑터를 통해 분배됨
- 해당 가상머신은 획득한 논리적 디스크 자원을 물리적 자원처럼 인식

### 외장 디스크

- 가상 I/O 레이어가 파이버 채널 어댑터를 통해서 외장 디스크의 LUN을 획득
- 가상 I/O 레이어가 자원을 바로 각 가상머신에 가상 디스크 어댑터를 통해서 분배
- 가상 I/O 레이어를 통해 제공된 논리적 디스크 볼륨은 이를 이용하는 다른 가상머신에게 SCSI 디스크로 나타남