# 등분산성 검정: Levene, Bartlett

**등분산성(Homoscedasticity)**: 두 개 이상의 그룹(모집단) 간에 분산이 동일하다는 가정
- 두 집단의 평균을 비교하는 `독립표본 t-검정(Independent two-sample t-test)`이나 세 개 이상 집단의 평균을 비교하는 `분산분석(ANOVA)`과 같은 모수 통계 분석에서 중요한 전제 조건 중 하나
- 만약 그룹 간 분산이 서로 다르면(이분산성, Heteroscedasticity),
    - 일반적인 `t-test`나 `ANOVA`의 결과가 왜곡될 수 있음
    - 분석 수행 전, 등분산성 가정이 만족되는지를 먼저 검정하는 것이 중요

등분산성 검정의 가설 설정
- **귀무가설 (H₀)**: 모든 그룹의 분산은 동일하다 (등분산성을 만족한다).
- **대립가설 (H₁)**: 적어도 한 그룹의 분산은 다른 그룹과 다르다 (등분산성을 만족하지 않는다).

검정 결과 `p-value`가 유의수준(e.g., 0.05)보다 **작으면** 귀무가설을 기각하고, "그룹 간 분산이 다르다(이분산성)"고 결론 내립니다.<br>
반대로 `p-value`가 유의수준보다 **크면** 귀무가설을 기각할 수 없으므로, "그룹 간 분산이 동일하다고 볼 수 있다(등분산성)"고 판단합니다.

### Levene's Test (레빈 검정)
- 각 그룹의 데이터 값과 해당 그룹의 **중앙값(median)** 간의 편차를 이용하여 분산의 동질성을 검정
- 데이터가 정규분포를 따르지 않을 때도 사용 가능
- `Bartlett 검정`보다 더 강건(robust)하고 일반적으로 널리 사용

### Bartlett's Test (바틀렛 검정)
- 각 그룹의 분산을 직접 계산하여 카이제곱 분포를 이용해 분산의 동질성을 검정
- **데이터가 정규분포를 따른다는 가정** 하에서만 정확한 결과를 제공
- 만약 데이터가 정규분포를 따르지 않으면, 실제로는 등분산임에도 불구하고 귀무가설을 기각하는 경향이 존재

## 적용 가능한 상황

- **독립표본 t-검정 수행 전**: 두 그룹의 분산이 같은지 다른지에 따라 t-검정의 옵션(`equal_var`)이 달라지므로, 사전에 등분산성 검정을 수행합니다.
- **분산분석(ANOVA) 수행 전**: ANOVA는 기본적으로 모든 그룹의 분산이 동일하다는 가정을 전제로 하므로, 이 가정이 만족되는지 확인하기 위해 사용합니다.

## 예제 데이터 생성

```python
import numpy as np
from scipy import stats

np.random.seed(0)

# 1. 등분산을 만족하는 두 그룹 (분산이 비슷함)
group1_equal_var = np.random.normal(loc=5, scale=2, size=50)
group2_equal_var = np.random.normal(loc=5, scale=2.2, size=50)

# 2. 이분산을 만족하는 두 그룹 (분산이 다름)
group1_unequal_var = np.random.normal(loc=5, scale=2, size=50)
group2_unequal_var = np.random.normal(loc=5, scale=4, size=50)

# 3. 정규분포를 따르지 않는 데이터 (비교용)
group3_non_normal = np.random.uniform(low=0, high=10, size=50)
```

## 1. Levene's Test

- 그룹 간 등분산성을 검정 (데이터의 정규성 가정 불필요, 가장 일반적으로 권장됨)
- **주의사항**
    - `center` 파라미터를 통해 중심점을 'median'(기본값), 'mean', 'trimmed' 중에서 선택 가능
    - 'median'이 가장 강건한 방법

```python
# 등분산 데이터에 대한 검정
levene_stat_equal, levene_p_equal = stats.levene(group1_equal_var, group2_equal_var)
print("-- Levene's Test on Equal Variance Data --")
print(f"Statistic: {levene_stat_equal:.4f}, p-value: {levene_p_equal:.4f}")
if levene_p_equal > 0.05:
    print("귀무가설 기각 실패: 그룹 간 분산은 동일합니다 (등분산성).")
else:
    print("귀무가설 기각: 그룹 간 분산은 다릅니다 (이분산성).")
'''
-- Levene's Test on Equal Variance Data --
Statistic: 1.0442, p-value: 0.3094
귀무가설 기각 실패: 그룹 간 분산은 동일합니다 (등분산성).
'''

# 이분산 데이터에 대한 검정
levene_stat_unequal, levene_p_unequal = stats.levene(group1_unequal_var, group2_unequal_var)
print("\n-- Levene's Test on Unequal Variance Data --")
print(f"Statistic: {levene_stat_unequal:.4f}, p-value: {levene_p_unequal:.4f}")
if levene_p_unequal > 0.05:
    print("귀무가설 기각 실패: 그룹 간 분산은 동일합니다 (등분산성).")
else:
    print("귀무가설 기각: 그룹 간 분산은 다릅니다 (이분산성).")
'''
-- Levene's Test on Unequal Variance Data --
Statistic: 21.8024, p-value: 0.0000
귀무가설 기각: 그룹 간 분산은 다릅니다 (이분산성).
'''
```
- **결과 해석**:
  - **Equal Variance Data**: `p-value(0.3094)`가 0.05보다 크므로, 귀무가설을 기각하지 못합니다. 즉, 두 그룹의 분산은 동일하다고 볼 수 있습니다.
  - **Unequal Variance Data**: `p-value(0.0000)`가 0.05보다 작으므로, 귀무가설을 기각합니다. 즉, 두 그룹의 분산은 통계적으로 유의미하게 다르다고 결론 내립니다.

## 2. Bartlett's Test

- 그룹 간 등분산성을 검정 (데이터가 정규분포를 따를 때 사용)
- **주의사항**
    - 데이터가 정규분포를 따르지 않으면 잘못된 결과를 줄 수 있습니다.

```python
# 등분산 데이터에 대한 검정
bartlett_stat_equal, bartlett_p_equal = stats.bartlett(group1_equal_var, group2_equal_var)
print("-- Bartlett's Test on Equal Variance Data --")
print(f"Statistic: {bartlett_stat_equal:.4f}, p-value: {bartlett_p_equal:.4f}")
# Statistic: 1.3237, p-value: 0.2499

# 이분산 데이터에 대한 검정
bartlett_stat_unequal, bartlett_p_unequal = stats.bartlett(group1_unequal_var, group2_unequal_var)
print("\n-- Bartlett's Test on Unequal Variance Data --")
print(f"Statistic: {bartlett_stat_unequal:.4f}, p-value: {bartlett_p_unequal:.4f}")
# Statistic: 20.2517, p-value: 0.0000

# 정규분포를 따르지 않는 데이터에 대한 검정 (Levene과 비교)
levene_stat_nn, levene_p_nn = stats.levene(group1_equal_var, group3_non_normal)
bartlett_stat_nn, bartlett_p_nn = stats.bartlett(group1_equal_var, group3_non_normal)
print("\n-- Tests on Non-normal Data --")
print(f"Levene p-value: {levene_p_nn:.4f}") # 0.0001
print(f"Bartlett p-value: {bartlett_p_nn:.4f}") # 0.0093
```
- **결과 해석**
    - 정규분포를 따르는 데이터에 대해서는 Levene 검정과 유사한 결과를 보입니다.
    - 하지만 `group3_non_normal`과 비교 시, `Levene 검정`보다 `Bartlett 검정`의 p-value가 더 크게 나오는 것을 볼 수 있습니다.
    - `Bartlett 검정`이 데이터의 비정규성에 민감함을 보여줍니다.

## 검정 방법 선택 가이드

1.  **정규성 검정 우선 수행**: 등분산성 검정을 하기 전에, 각 그룹의 데이터가 정규분포를 따르는지 `stats.shapiro()` 등을 통해 먼저 확인합니다.

2.  **데이터가 정규분포를 따르는 경우**: **Bartlett's Test**가 더 높은 검정력을 가질 수 있어 선호될 수 있습니다. 하지만 **Levene's Test**를 사용해도 무방합니다.

3.  **데이터가 정규분포를 따르지 않는 경우**: 반드시 **Levene's Test**를 사용해야 합니다. **Bartlett's Test**는 신뢰할 수 없는 결과를 반환합니다.

4.  **일반적인 경우**: 어떤 경우에나 안정적인 결과를 주는 **Levene's Test**를 기본적으로 사용하는 것이 가장 안전하고 일반적인 접근 방식입니다.

### 등분산성 가정이 위배되었을 때의 대안
- **독립표본 t-검정**: `stats.ttest_ind` 함수에서 `equal_var=False` 옵션을 설정하여 **Welch's t-test**를 수행합니다. 이는 등분산 가정이 만족되지 않을 때 사용하는 t-검정입니다.
- **분산분석(ANOVA)**: **Welch's ANOVA**나 **Brown-Forsythe Test**와 같은 대안적인 분산분석 방법을 사용합니다. (`pingouin.welch_anova` 등)
- **비모수 검정**: 데이터의 분포에 대한 가정이 없는 비모수적 방법(e.g., Mann-Whitney U test)을 고려할 수 있습니다.
